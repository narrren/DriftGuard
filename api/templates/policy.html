<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DriftGuard ‚Äî Policy Configuration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background: #0a0f1e;
        }

        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }

        .sidebar-item {
            transition: all 0.15s ease;
        }

        .sidebar-item:hover,
        .sidebar-item.active {
            background: rgba(99, 102, 241, 0.1);
            border-color: rgba(99, 102, 241, 0.3);
            color: white;
        }

        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        .glow-text {
            text-shadow: 0 0 20px rgba(99, 102, 241, 0.5);
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(0.8);
                opacity: 1;
            }

            100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        .pulse-ring::before {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            border: 2px solid #10b981;
            animation: pulse-ring 2s infinite;
        }

        .status-dot {
            position: relative;
            display: inline-block;
        }

        .btn-action {
            transition: all 0.2s ease;
        }

        .btn-action:hover {
            transform: translateY(-1px);
        }

        .btn-action:active {
            transform: translateY(0);
        }

        .toast {
            transform: translateX(120%);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        /* Code editor */
        .code-editor {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            line-height: 1.6;
            background: #0d1117;
            color: #c9d1d9;
            border: none;
            outline: none;
            resize: none;
            width: 100%;
            height: 100%;
            padding: 1rem;
            tab-size: 2;
        }

        .yaml-key {
            color: #79c0ff;
        }

        .yaml-str {
            color: #a5d6ff;
        }

        .yaml-bool {
            color: #ff79c6;
        }

        .yaml-num {
            color: #bd93f9;
        }

        .yaml-comment {
            color: #8b949e;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: 0
            }
        }

        .cursor-blink {
            animation: blink 1s infinite;
        }
    </style>
</head>

<body class="text-slate-300 min-h-screen flex">

    <!-- Sidebar -->
    <aside class="w-64 flex-shrink-0 border-r border-white/5 bg-[#0d1117] flex flex-col h-screen sticky top-0">
        <div class="p-6 border-b border-white/5">
            <a href="/" class="flex items-center gap-3">
                <div
                    class="w-9 h-9 rounded-xl bg-gradient-to-tr from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold shadow-lg shadow-indigo-500/20">
                    D</div>
                <span class="text-lg font-bold text-white">DriftGuard</span>
            </a>
        </div>
        <div
            class="px-4 py-3 mx-4 mt-4 rounded-xl bg-emerald-500/10 border border-emerald-500/20 flex items-center gap-2">
            <span class="status-dot pulse-ring w-2 h-2 rounded-full bg-emerald-400 flex-shrink-0"></span>
            <span class="text-xs font-semibold text-emerald-400 font-mono">LIVE MODE</span>
        </div>
        <nav class="flex-1 px-3 py-4 space-y-1 overflow-y-auto">
            <a href="/dashboard"
                class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-lg border border-transparent text-sm font-medium text-slate-400"><span>üè†</span>
                Dashboard</a>
            <a href="/ai-guard"
                class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-lg border border-transparent text-sm font-medium text-slate-400"><span>üß†</span>
                AI Guard</a>
            <a href="/janitor"
                class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-lg border border-transparent text-sm font-medium text-slate-400"><span>üßπ</span>
                Janitor</a>
            <a href="/sentry"
                class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-lg border border-transparent text-sm font-medium text-slate-400"><span>üõ°Ô∏è</span>
                Sentry</a>
            <a href="/finops"
                class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-lg border border-transparent text-sm font-medium text-slate-400"><span>üí∞</span>
                FinOps</a>
            <a href="/policy"
                class="sidebar-item active flex items-center gap-3 px-3 py-2.5 rounded-lg border border-transparent text-sm font-medium"><span>üìã</span>
                Policy</a>
        </nav>
        <div class="p-4 border-t border-white/5">
            <p class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-3">Cloud Connections</p>
            <div class="space-y-2">
                <div class="flex items-center justify-between text-xs"><span class="text-slate-400">AWS</span><span
                        id="sb-aws" class="text-slate-600 font-mono">‚Äî</span></div>
                <div class="flex items-center justify-between text-xs"><span class="text-slate-400">Azure</span><span
                        id="sb-azure" class="text-slate-600 font-mono">‚Äî</span></div>
                <div class="flex items-center justify-between text-xs"><span class="text-slate-400">GCP</span><span
                        id="sb-gcp" class="text-slate-600 font-mono">‚Äî</span></div>
            </div>
        </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 overflow-y-auto">
        <header
            class="sticky top-0 z-40 border-b border-white/5 bg-[#0a0f1e]/80 backdrop-blur-xl px-8 py-4 flex items-center justify-between">
            <div>
                <h1 class="text-xl font-bold text-white glow-text">üìã Policy Configuration</h1>
                <p class="text-xs text-slate-500 font-mono mt-0.5" id="policyStatus">Last updated: just now by admin</p>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="dryRun()"
                    class="btn-action px-4 py-2 border border-white/10 hover:bg-white/5 text-white text-sm font-medium rounded-lg transition">‚ñ∑
                    Dry Run</button>
                <button onclick="runPipeline()" id="btnRun"
                    class="btn-action px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-semibold rounded-lg shadow-lg shadow-indigo-600/20">‚ñ∂
                    Run Pipeline</button>
                <button onclick="savePolicy()"
                    class="btn-action px-4 py-2 bg-emerald-600/80 hover:bg-emerald-500 text-white text-sm font-semibold rounded-lg">üíæ
                    Save</button>
            </div>
        </header>

        <div class="p-8 space-y-8">
            <!-- Stats -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="glass rounded-xl p-5">
                    <p class="text-xs text-slate-500 uppercase tracking-wider mb-1">Active Rules</p>
                    <p class="text-3xl font-bold text-white">4</p>
                    <p class="text-xs text-emerald-400 mt-1">‚óè all enforced</p>
                </div>
                <div class="glass rounded-xl p-5">
                    <p class="text-xs text-slate-500 uppercase tracking-wider mb-1">Critical</p>
                    <p class="text-3xl font-bold text-white">2</p>
                    <p class="text-xs text-red-400 mt-1">‚ö† block on fail</p>
                </div>
                <div class="glass rounded-xl p-5">
                    <p class="text-xs text-slate-500 uppercase tracking-wider mb-1">Warnings</p>
                    <p class="text-3xl font-bold text-white">2</p>
                    <p class="text-xs text-yellow-400 mt-1">‚ö° notify on fail</p>
                </div>
                <div class="glass rounded-xl p-5">
                    <p class="text-xs text-slate-500 uppercase tracking-wider mb-1">Policy Version</p>
                    <p class="text-lg font-bold text-indigo-400 mt-1">v2.1</p>
                    <p class="text-xs text-slate-500 mt-1">current</p>
                </div>
            </div>

            <!-- Editor + Rules -->
            <div class="grid md:grid-cols-3 gap-6">
                <!-- Code Editor -->
                <div class="glass rounded-xl overflow-hidden md:col-span-2 flex flex-col" style="min-height:500px">
                    <div class="flex items-center justify-between px-4 py-2 bg-white/[0.02] border-b border-white/5">
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-mono text-slate-400 font-bold">policy.yaml</span>
                            <span
                                class="bg-indigo-500/20 text-indigo-400 text-[10px] px-1.5 py-0.5 rounded font-mono">v2.1</span>
                            <span class="text-xs text-emerald-400 font-mono" id="validBadge">‚úì Valid YAML</span>
                        </div>
                        <button onclick="copyPolicy()"
                            class="text-xs text-slate-500 hover:text-white transition px-2 py-1 rounded hover:bg-white/5">Copy</button>
                    </div>
                    <div class="flex flex-1 overflow-hidden">
                        <!-- Line numbers -->
                        <div class="bg-[#0d1117] border-r border-white/5 px-3 py-4 text-slate-600 font-mono text-xs leading-6 select-none text-right min-w-[2.5rem]"
                            id="lineNumbers">
                            1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30
                        </div>
                        <!-- Syntax highlighted display -->
                        <div class="flex-1 overflow-auto bg-[#0d1117] p-4 font-mono text-xs leading-6" id="codeDisplay">
                            <span class="yaml-key">version</span>: <span class="yaml-str">"v2.1"</span>

                            <span class="yaml-comment"># Core Engine Configuration</span>
                            <span class="yaml-key">engine</span>:
                            <span class="yaml-key">mode</span>: <span class="yaml-str">"active_enforcement"</span>
                            <span class="yaml-key">scan_interval</span>: <span class="yaml-str">"5m"</span>
                            <span class="yaml-key">telemetry</span>:
                            <span class="yaml-key">enabled</span>: <span class="yaml-bool">true</span>
                            <span class="yaml-key">endpoint</span>: <span
                                class="yaml-str">"https://metrics.driftguard.io"</span>

                            <span class="yaml-comment"># Compliance Rules</span>
                            <span class="yaml-key">rules</span>:
                            - <span class="yaml-key">id</span>: <span class="yaml-str">"aws-s3-no-public"</span>
                            <span class="yaml-key">severity</span>: <span class="yaml-str">"critical"</span>
                            <span class="yaml-key">description</span>: <span class="yaml-str">"Ensure S3 buckets block
                                public access"</span>
                            <span class="yaml-key">action</span>: <span class="yaml-str">"remediate"</span>

                            - <span class="yaml-key">id</span>: <span class="yaml-str">"k8s-limit-cpu"</span>
                            <span class="yaml-key">severity</span>: <span class="yaml-str">"warning"</span>
                            <span class="yaml-key">action</span>: <span class="yaml-str">"notify"</span>
                            <span class="yaml-key">threshold</span>: <span class="yaml-num">80</span>

                            - <span class="yaml-key">id</span>: <span class="yaml-str">"doc-drift-guard"</span>
                            <span class="yaml-key">severity</span>: <span class="yaml-str">"critical"</span>
                            <span class="yaml-key">description</span>: <span class="yaml-str">"Block PRs with
                                undocumented env vars"</span>
                            <span class="yaml-key">action</span>: <span class="yaml-str">"block"</span>
                            <span class="yaml-key">ai_model</span>: <span class="yaml-str">"gemini-1.5-flash"</span>

                            - <span class="yaml-key">id</span>: <span class="yaml-str">"janitor-ttl-cleanup"</span>
                            <span class="yaml-key">severity</span>: <span class="yaml-str">"warning"</span>
                            <span class="yaml-key">description</span>: <span class="yaml-str">"Reap resources with
                                expired TTL tags"</span>
                            <span class="yaml-key">action</span>: <span class="yaml-str">"remediate"</span>
                            <span class="yaml-key">providers</span>: [<span class="yaml-str">"aws"</span>, <span
                                class="yaml-str">"azure"</span>, <span class="yaml-str">"gcp"</span>]<span
                                class="cursor-blink text-indigo-400">|</span>
                        </div>
                    </div>
                    <div
                        class="px-4 py-2 border-t border-white/5 bg-white/[0.02] flex justify-between items-center text-xs">
                        <span id="dryRunStatus" class="font-mono text-slate-500"></span>
                        <span class="text-slate-600 font-mono">DriftGuard Policy Engine v2.1</span>
                    </div>
                </div>

                <!-- Rules Panel -->
                <div class="flex flex-col gap-4">
                    <!-- Cloud Status -->
                    <div class="glass rounded-xl p-5">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-sm font-semibold text-white">Cloud OIDC Status</h3>
                            <a href="/login" class="text-xs text-indigo-400 hover:text-indigo-300">Manage ‚Üí</a>
                        </div>
                        <div class="space-y-2" id="cloudStatusList">
                            <div
                                class="flex items-center justify-between p-2 rounded-lg bg-white/[0.02] border border-white/5">
                                <div class="flex items-center gap-2"><span class="text-sm">üü†</span><span
                                        class="text-sm text-white">AWS</span></div>
                                <span id="cloud-aws" class="text-xs font-mono text-slate-600">Checking...</span>
                            </div>
                            <div
                                class="flex items-center justify-between p-2 rounded-lg bg-white/[0.02] border border-white/5">
                                <div class="flex items-center gap-2"><span class="text-sm">üîµ</span><span
                                        class="text-sm text-white">Azure</span></div>
                                <span id="cloud-azure" class="text-xs font-mono text-slate-600">Checking...</span>
                            </div>
                            <div
                                class="flex items-center justify-between p-2 rounded-lg bg-white/[0.02] border border-white/5">
                                <div class="flex items-center gap-2"><span class="text-sm">üî¥</span><span
                                        class="text-sm text-white">GCP</span></div>
                                <span id="cloud-gcp" class="text-xs font-mono text-slate-600">Checking...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Active Rules -->
                    <div class="glass rounded-xl p-5">
                        <h3 class="text-sm font-semibold text-white mb-3">Active Rules</h3>
                        <div class="space-y-2">
                            <div
                                class="flex items-center justify-between p-2 rounded-lg bg-red-500/5 border border-red-500/10">
                                <span class="text-xs text-white font-mono">aws-s3-no-public</span>
                                <span class="text-xs text-red-400">critical</span>
                            </div>
                            <div
                                class="flex items-center justify-between p-2 rounded-lg bg-yellow-500/5 border border-yellow-500/10">
                                <span class="text-xs text-white font-mono">k8s-limit-cpu</span>
                                <span class="text-xs text-yellow-400">warning</span>
                            </div>
                            <div
                                class="flex items-center justify-between p-2 rounded-lg bg-red-500/5 border border-red-500/10">
                                <span class="text-xs text-white font-mono">doc-drift-guard</span>
                                <span class="text-xs text-red-400">critical</span>
                            </div>
                            <div
                                class="flex items-center justify-between p-2 rounded-lg bg-yellow-500/5 border border-yellow-500/10">
                                <span class="text-xs text-white font-mono">janitor-ttl-cleanup</span>
                                <span class="text-xs text-yellow-400">warning</span>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="glass rounded-xl p-5">
                        <h3 class="text-sm font-semibold text-white mb-3">Quick Actions</h3>
                        <div class="space-y-2">
                            <a href="/ai-guard"
                                class="flex items-center gap-2 p-2.5 rounded-lg bg-white/[0.02] border border-white/5 hover:border-indigo-500/20 transition text-sm text-white"><span>üß†</span>
                                Run AI Doc Analysis</a>
                            <a href="/janitor"
                                class="flex items-center gap-2 p-2.5 rounded-lg bg-white/[0.02] border border-white/5 hover:border-indigo-500/20 transition text-sm text-white"><span>üßπ</span>
                                Run Janitor Scan</a>
                            <a href="/sentry"
                                class="flex items-center gap-2 p-2.5 rounded-lg bg-white/[0.02] border border-white/5 hover:border-indigo-500/20 transition text-sm text-white"><span>üõ°Ô∏è</span>
                                Trigger Sentry</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pipeline Log -->
            <div class="glass rounded-xl p-6">
                <h2 class="text-sm font-semibold text-white mb-4 flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-indigo-400"></span>
                    Pipeline Execution Log
                </h2>
                <div id="pipelineLog" class="font-mono text-xs text-slate-400 space-y-1.5 h-32 overflow-y-auto">
                    <div class="text-slate-600">Click "Run Pipeline" or "Dry Run" to execute...</div>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast -->
    <div id="toast"
        class="toast fixed bottom-6 right-6 z-50 px-5 py-3 rounded-xl text-sm font-medium text-white shadow-2xl flex items-center gap-3 min-w-[280px]">
        <span id="toastIcon">‚úì</span><span id="toastMsg">Done</span>
    </div>

    <script>
        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            document.getElementById('toastMsg').textContent = msg;
            document.getElementById('toastIcon').textContent = type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚Ñπ';
            toast.className = `toast show fixed bottom-6 right-6 z-50 px-5 py-3 rounded-xl text-sm font-medium text-white shadow-2xl flex items-center gap-3 min-w-[280px] ${type === 'success' ? 'bg-emerald-600' : type === 'error' ? 'bg-red-600' : 'bg-indigo-600'}`;
            setTimeout(() => toast.classList.remove('show'), 3500);
        }
        function addLog(msg, type = 'info') {
            const log = document.getElementById('pipelineLog');
            const colors = { info: 'text-slate-400', success: 'text-emerald-400', error: 'text-red-400', warn: 'text-yellow-400' };
            const time = new Date().toLocaleTimeString();
            if (log.querySelector('.text-slate-600')) log.innerHTML = '';
            log.innerHTML += `<div class="${colors[type] || 'text-slate-400'}">[${time}] ${msg}</div>`;
            log.scrollTop = log.scrollHeight;
        }
        function copyPolicy() {
            const text = document.getElementById('codeDisplay').textContent;
            navigator.clipboard.writeText(text).then(() => showToast('Policy copied!', 'success'));
        }
        function savePolicy() {
            showToast('Policy saved! (write to policy.yaml in production)', 'success');
            addLog('Policy saved ‚Äî v2.1', 'success');
        }
        async function dryRun() {
            const status = document.getElementById('dryRunStatus');
            status.textContent = 'Running dry run...';
            status.className = 'font-mono text-yellow-400';
            addLog('Starting dry run...', 'info');
            showToast('Running dry run...', 'info');
            try {
                const res = await fetch('/api/run_pipeline', { method: 'POST' });
                const data = await res.json();
                status.textContent = '‚úì Dry run: ' + data.status;
                status.className = 'font-mono text-emerald-400';
                addLog(`Dry run: ${data.status}`, 'success');
                if (data.results) Object.entries(data.results).forEach(([k, v]) => addLog(`  ${k}: ${v}`, v === 'success' ? 'success' : 'error'));
                showToast('Dry run complete!', 'success');
            } catch (e) {
                status.textContent = 'Dry run failed';
                status.className = 'font-mono text-red-400';
                addLog(`Error: ${e.message}`, 'error');
                showToast('Dry run failed', 'error');
            }
        }
        async function runPipeline() {
            const btn = document.getElementById('btnRun');
            btn.textContent = '‚è≥ Running...'; btn.disabled = true;
            addLog('Executing full pipeline...', 'info');
            showToast('Running pipeline...', 'info');
            try {
                const res = await fetch('/api/run_pipeline', { method: 'POST' });
                const data = await res.json();
                addLog(`Pipeline: ${data.status}`, 'success');
                if (data.results) Object.entries(data.results).forEach(([k, v]) => addLog(`  ${k}: ${v}`, v === 'success' ? 'success' : 'error'));
                showToast('Pipeline complete!', 'success');
            } catch (e) {
                addLog(`Error: ${e.message}`, 'error');
                showToast('Pipeline failed', 'error');
            }
            btn.textContent = '‚ñ∂ Run Pipeline'; btn.disabled = false;
        }
        async function loadCloudStatus() {
            try {
                const res = await fetch('/auth/status');
                const status = await res.json();
                ['aws', 'azure', 'gcp'].forEach(k => {
                    const el = document.getElementById(`cloud-${k}`);
                    const sb = document.getElementById(`sb-${k}`);
                    const connected = status[k]?.connected;
                    if (el) el.innerHTML = connected ? '<span class="text-emerald-400">‚óè Connected</span>' : '<span class="text-slate-600">‚óã Not connected</span>';
                    if (sb) sb.innerHTML = connected ? '<span class="text-emerald-400">‚óè on</span>' : '<span class="text-slate-600">‚óã off</span>';
                });
            } catch (e) { }
        }
        loadCloudStatus();
    </script>
</body>

</html>