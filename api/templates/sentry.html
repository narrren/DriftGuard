<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DriftGuard ‚Äî Sentry Cross-Repo Signals</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background: #0a0f1e;
        }

        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }

        .sidebar-item {
            transition: all 0.15s ease;
        }

        .sidebar-item:hover,
        .sidebar-item.active {
            background: rgba(99, 102, 241, 0.1);
            border-color: rgba(99, 102, 241, 0.3);
            color: white;
        }

        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        .glow-text {
            text-shadow: 0 0 20px rgba(99, 102, 241, 0.5);
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(0.8);
                opacity: 1;
            }

            100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        .pulse-ring::before {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            border: 2px solid #10b981;
            animation: pulse-ring 2s infinite;
        }

        .status-dot {
            position: relative;
            display: inline-block;
        }

        .btn-action {
            transition: all 0.2s ease;
        }

        .btn-action:hover {
            transform: translateY(-1px);
        }

        .btn-action:active {
            transform: translateY(0);
        }

        .toast {
            transform: translateX(120%);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        @keyframes radar-sweep {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .radar-sweep {
            animation: radar-sweep 3s linear infinite;
            transform-origin: center;
        }

        @keyframes signal-pulse {

            0%,
            100% {
                opacity: 0.2;
                transform: scale(1);
            }

            50% {
                opacity: 1;
                transform: scale(1.05);
            }
        }

        .signal-pulse {
            animation: signal-pulse 2s ease-in-out infinite;
        }
    </style>
</head>

<body class="text-slate-300 min-h-screen flex">

    <!-- Sidebar -->
    <aside class="w-64 flex-shrink-0 border-r border-white/5 bg-[#0d1117] flex flex-col h-screen sticky top-0">
        <div class="p-6 border-b border-white/5">
            <a href="/" class="flex items-center gap-3">
                <div
                    class="w-9 h-9 rounded-xl bg-gradient-to-tr from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold shadow-lg shadow-indigo-500/20">
                    D</div>
                <span class="text-lg font-bold text-white">DriftGuard</span>
            </a>
        </div>
        <div
            class="px-4 py-3 mx-4 mt-4 rounded-xl bg-emerald-500/10 border border-emerald-500/20 flex items-center gap-2">
            <span class="status-dot pulse-ring w-2 h-2 rounded-full bg-emerald-400 flex-shrink-0"></span>
            <span class="text-xs font-semibold text-emerald-400 font-mono">LIVE MODE</span>
        </div>
        <nav class="flex-1 px-3 py-4 space-y-1 overflow-y-auto">
            <a href="/dashboard"
                class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-lg border border-transparent text-sm font-medium text-slate-400"><span>üè†</span>
                Dashboard</a>
            <a href="/ai-guard"
                class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-lg border border-transparent text-sm font-medium text-slate-400"><span>üß†</span>
                AI Guard</a>
            <a href="/janitor"
                class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-lg border border-transparent text-sm font-medium text-slate-400"><span>üßπ</span>
                Janitor</a>
            <a href="/sentry"
                class="sidebar-item active flex items-center gap-3 px-3 py-2.5 rounded-lg border border-transparent text-sm font-medium"><span>üõ°Ô∏è</span>
                Sentry</a>
            <a href="/finops"
                class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-lg border border-transparent text-sm font-medium text-slate-400"><span>üí∞</span>
                FinOps</a>
            <a href="/policy"
                class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-lg border border-transparent text-sm font-medium text-slate-400"><span>üìã</span>
                Policy</a>
        </nav>
        <div class="p-4 border-t border-white/5">
            <p class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-3">Cloud Connections</p>
            <div class="space-y-2">
                <div class="flex items-center justify-between text-xs"><span class="text-slate-400">AWS</span><span
                        id="sb-aws" class="text-slate-600 font-mono">‚Äî</span></div>
                <div class="flex items-center justify-between text-xs"><span class="text-slate-400">Azure</span><span
                        id="sb-azure" class="text-slate-600 font-mono">‚Äî</span></div>
                <div class="flex items-center justify-between text-xs"><span class="text-slate-400">GCP</span><span
                        id="sb-gcp" class="text-slate-600 font-mono">‚Äî</span></div>
            </div>
        </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 overflow-y-auto">
        <header
            class="sticky top-0 z-40 border-b border-white/5 bg-[#0a0f1e]/80 backdrop-blur-xl px-8 py-4 flex items-center justify-between">
            <div>
                <h1 class="text-xl font-bold text-white glow-text">üõ°Ô∏è Sentry ‚Äî Cross-Repo Signals</h1>
                <p class="text-xs text-slate-500 font-mono mt-0.5" id="sentryStatus">Monitoring downstream repositories
                    for drift signals</p>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="triggerSentry()" id="btnSentry"
                    class="btn-action px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-semibold rounded-lg shadow-lg shadow-indigo-600/20">üì°
                    Dispatch Signal</button>
                <button onclick="checkRepos()"
                    class="btn-action px-4 py-2 border border-white/10 hover:bg-white/5 text-white text-sm font-medium rounded-lg transition">üîç
                    Check Repos</button>
            </div>
        </header>

        <div class="p-8 space-y-8">
            <!-- Stats -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="glass rounded-xl p-5">
                    <p class="text-xs text-slate-500 uppercase tracking-wider mb-1">Signals Sent</p>
                    <p class="text-3xl font-bold text-white" id="statSignals">0</p>
                    <p class="text-xs text-slate-500 mt-1">this session</p>
                </div>
                <div class="glass rounded-xl p-5">
                    <p class="text-xs text-slate-500 uppercase tracking-wider mb-1">Repos Watched</p>
                    <p class="text-3xl font-bold text-white" id="statRepos">1</p>
                    <p class="text-xs text-emerald-400 mt-1">‚óè active</p>
                </div>
                <div class="glass rounded-xl p-5">
                    <p class="text-xs text-slate-500 uppercase tracking-wider mb-1">Last Signal</p>
                    <p class="text-lg font-bold text-white mt-1" id="statLastSignal">Never</p>
                    <p class="text-xs text-slate-500 mt-1">dispatch time</p>
                </div>
                <div class="glass rounded-xl p-5">
                    <p class="text-xs text-slate-500 uppercase tracking-wider mb-1">PAT Status</p>
                    <p class="text-lg font-bold mt-1" id="statPAT">Checking...</p>
                    <p class="text-xs text-slate-500 mt-1">GitHub token</p>
                </div>
            </div>

            <!-- Radar + Repos -->
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Radar visual -->
                <div class="glass rounded-xl p-6 flex flex-col items-center justify-center">
                    <h2 class="text-sm font-semibold text-white mb-6 self-start flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-indigo-400"></span>
                        Signal Radar
                    </h2>
                    <div class="relative w-48 h-48">
                        <!-- Rings -->
                        <div class="absolute inset-0 rounded-full border border-indigo-500/10"></div>
                        <div class="absolute inset-4 rounded-full border border-indigo-500/15"></div>
                        <div class="absolute inset-8 rounded-full border border-indigo-500/20"></div>
                        <div class="absolute inset-12 rounded-full border border-indigo-500/30"></div>
                        <!-- Sweep -->
                        <svg class="absolute inset-0 w-full h-full" viewBox="0 0 100 100">
                            <defs>
                                <linearGradient id="sweep" x1="50%" y1="50%" x2="100%" y2="50%">
                                    <stop offset="0%" stop-color="#6366f1" stop-opacity="0.4" />
                                    <stop offset="100%" stop-color="#6366f1" stop-opacity="0" />
                                </linearGradient>
                            </defs>
                            <path class="radar-sweep" d="M50,50 L100,50 A50,50 0 0,0 50,0 Z" fill="url(#sweep)" />
                        </svg>
                        <!-- Center dot -->
                        <div class="absolute inset-0 flex items-center justify-center">
                            <div class="w-3 h-3 rounded-full bg-indigo-500 shadow-[0_0_10px_rgba(99,102,241,0.8)]">
                            </div>
                        </div>
                        <!-- Signal dots -->
                        <div id="signalDots" class="absolute inset-0">
                            <div class="signal-pulse absolute w-2 h-2 rounded-full bg-emerald-400 shadow-[0_0_6px_rgba(16,185,129,0.8)]"
                                style="top:25%;left:70%"></div>
                            <div class="signal-pulse absolute w-1.5 h-1.5 rounded-full bg-yellow-400"
                                style="top:65%;left:20%;animation-delay:0.5s"></div>
                        </div>
                    </div>
                    <p class="text-xs text-slate-500 font-mono mt-4">Scanning narrren/DriftGuard</p>
                </div>

                <!-- Repo list -->
                <div class="glass rounded-xl p-6">
                    <h2 class="text-sm font-semibold text-white mb-4 flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-purple-400"></span>
                        Watched Repositories
                    </h2>
                    <div class="space-y-3" id="repoList">
                        <div
                            class="flex items-center justify-between p-3 rounded-lg bg-white/[0.02] border border-white/5 hover:border-indigo-500/20 transition">
                            <div class="flex items-center gap-3">
                                <span class="text-lg">üì¶</span>
                                <div>
                                    <p class="text-white text-sm font-medium">narrren/DriftGuard</p>
                                    <p class="text-slate-500 text-xs font-mono">main branch</p>
                                </div>
                            </div>
                            <span
                                class="text-xs font-mono px-2 py-1 rounded-full bg-emerald-500/10 text-emerald-400 border border-emerald-500/20">‚óè
                                Watching</span>
                        </div>
                        <div
                            class="flex items-center justify-between p-3 rounded-lg bg-white/[0.02] border border-white/5 hover:border-indigo-500/20 transition">
                            <div class="flex items-center gap-3">
                                <span class="text-lg">üì¶</span>
                                <div>
                                    <p class="text-white text-sm font-medium">narrren/infra-config</p>
                                    <p class="text-slate-500 text-xs font-mono">Not connected</p>
                                </div>
                            </div>
                            <a href="/login"
                                class="text-xs font-mono px-2 py-1 rounded-full bg-indigo-500/10 text-indigo-400 border border-indigo-500/20 hover:bg-indigo-500/20 transition">+
                                Connect</a>
                        </div>
                    </div>
                    <button onclick="checkRepos()"
                        class="btn-action mt-4 w-full py-2.5 bg-indigo-600/20 hover:bg-indigo-600/40 border border-indigo-500/30 text-indigo-300 text-sm font-medium rounded-lg transition">
                        Refresh Repo Status
                    </button>
                </div>
            </div>

            <!-- Signal Log -->
            <div class="glass rounded-xl p-6">
                <h2 class="text-sm font-semibold text-white mb-4 flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-yellow-400"></span>
                    Signal Dispatch Log
                </h2>
                <div id="signalLog" class="font-mono text-xs text-slate-400 space-y-1.5 h-40 overflow-y-auto">
                    <div class="text-slate-600">No signals dispatched yet. Click "Dispatch Signal" to trigger cross-repo
                        events.</div>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast -->
    <div id="toast"
        class="toast fixed bottom-6 right-6 z-50 px-5 py-3 rounded-xl text-sm font-medium text-white shadow-2xl flex items-center gap-3 min-w-[280px]">
        <span id="toastIcon">‚úì</span><span id="toastMsg">Done</span>
    </div>

    <script>
        let signalCount = 0;
        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            document.getElementById('toastMsg').textContent = msg;
            document.getElementById('toastIcon').textContent = type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚Ñπ';
            toast.className = `toast show fixed bottom-6 right-6 z-50 px-5 py-3 rounded-xl text-sm font-medium text-white shadow-2xl flex items-center gap-3 min-w-[280px] ${type === 'success' ? 'bg-emerald-600' : type === 'error' ? 'bg-red-600' : 'bg-indigo-600'}`;
            setTimeout(() => toast.classList.remove('show'), 3500);
        }
        function addLog(msg, type = 'info') {
            const log = document.getElementById('signalLog');
            const colors = { info: 'text-slate-400', success: 'text-emerald-400', error: 'text-red-400', warn: 'text-yellow-400' };
            const time = new Date().toLocaleTimeString();
            if (log.querySelector('.text-slate-600')) log.innerHTML = '';
            log.innerHTML += `<div class="${colors[type] || 'text-slate-400'}">[${time}] ${msg}</div>`;
            log.scrollTop = log.scrollHeight;
        }
        async function triggerSentry() {
            const btn = document.getElementById('btnSentry');
            btn.textContent = '‚è≥ Dispatching...'; btn.disabled = true;
            addLog('Dispatching repository_dispatch event to narrren/DriftGuard...', 'info');
            showToast('Dispatching signals...', 'info');
            try {
                const res = await fetch('/api/trigger_sentry', { method: 'POST' });
                const data = await res.json();
                const isError = data.status.includes('Error') || data.status.includes('Failed') || data.status.includes('not set');
                addLog(`Sentry: ${data.status}`, isError ? 'error' : 'success');
                if (!isError) {
                    signalCount++;
                    document.getElementById('statSignals').textContent = signalCount;
                    document.getElementById('statLastSignal').textContent = new Date().toLocaleTimeString();
                    // Add a new signal dot to radar
                    const dots = document.getElementById('signalDots');
                    const dot = document.createElement('div');
                    dot.className = 'signal-pulse absolute w-2 h-2 rounded-full bg-indigo-400 shadow-[0_0_6px_rgba(99,102,241,0.8)]';
                    dot.style.top = Math.random() * 70 + 15 + '%';
                    dot.style.left = Math.random() * 70 + 15 + '%';
                    dot.style.animationDelay = Math.random() + 's';
                    dots.appendChild(dot);
                }
                showToast(data.status, isError ? 'error' : 'success');
            } catch (e) {
                addLog(`Error: ${e.message}`, 'error');
                showToast('Dispatch failed', 'error');
            }
            btn.textContent = 'üì° Dispatch Signal'; btn.disabled = false;
        }
        async function checkRepos() {
            addLog('Checking repository status via GitHub API...', 'info');
            showToast('Checking repos...', 'info');
            try {
                const res = await fetch('/api/trigger_sentry', { method: 'POST' });
                const data = await res.json();
                addLog(`GitHub: ${data.status}`, data.status.includes('Error') ? 'error' : 'success');
                showToast('Repo check complete', 'success');
            } catch (e) {
                addLog(`Error: ${e.message}`, 'error');
            }
        }
        async function loadSidebarStatus() {
            try {
                const res = await fetch('/auth/status');
                const status = await res.json();
                ['aws', 'azure', 'gcp'].forEach(k => {
                    const el = document.getElementById(`sb-${k}`);
                    if (el) el.innerHTML = status[k]?.connected
                        ? '<span class="text-emerald-400">‚óè on</span>'
                        : '<span class="text-slate-600">‚óã off</span>';
                });
            } catch (e) { }
        }
        // Check PAT status
        async function checkPAT() {
            const patEl = document.getElementById('statPAT');
            try {
                const res = await fetch('/api/dashboard_status');
                const data = await res.json();
                const hasPAT = data.pipeline?.sentry === 'ready';
                patEl.textContent = hasPAT ? '‚óè Configured' : '‚óã Missing';
                patEl.className = `text-lg font-bold mt-1 ${hasPAT ? 'text-emerald-400' : 'text-red-400'}`;
            } catch (e) {
                patEl.textContent = '‚óã Unknown';
                patEl.className = 'text-lg font-bold mt-1 text-slate-500';
            }
        }
        loadSidebarStatus();
        checkPAT();
    </script>
</body>

</html>